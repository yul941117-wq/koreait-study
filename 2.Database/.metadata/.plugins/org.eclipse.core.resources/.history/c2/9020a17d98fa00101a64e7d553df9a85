-- 입사일이 1993년 2월19일 이면서 생일1962 10월 24일 직원의 이름을 구하고,
-- 다시 해당 이름으로 조건을 검색해서 사번(EMP_NO)를 구헤야 하는 경우.

select first_name, last_name  from employees
where hire_date = '1993-02-19'
and birth_date = '1964-10-24';

select emp_no from employees
where first_name = 'conrado'
and last_name = 'serra';

-- 서브 쿼리 사용 할꾸얀
select emp_no from employees
where first_name = (select first_name 
				from employees
				where hire_date = '1993-02-19'
				and birth_date = '1964-10-24')
and last_name = (select last_name
				from employees
				where hire_date = '1993-02-19'
				and birth_date = '1964-10-24');

-- 한줄로 만들었더
select  emp_no
from employees
where (first_name , last_name ) = (select first_name,last_name
									from employees
									where hire_date = '1993-02-19'
									and birth_date = '1964-10-24');

-- 직원중에서 EMP_NO가 가장 높은 직원 찾기 
-- 이름출력할꺼얀

select first_name, last_name
from employees
where emp_no =(select max(emp_no)
				from employees);

select max(emp_no),first_name, last_name, emp_no
from employees
group by first_name, employees.last_name, emp_no
order by emp_no desc
limit 1;

select first_name, last_name
from employees
order by emp_no desc
limit 1;

select first_name, last_name
from employees 
where hire_date = (select min(hire_date)
					from employees);

-- 전체 평균보다 높은 연봉을 받는 이름 조회 
select first_name, last_name
from employees
where emp_no =(select emp_no 
				from salaries s
				order by salary desc
				limit 1);

select emp_no from salaries s
order by salary desc
limit 1;

-- 평균 사범보다 높은 직원의 이름만 출력
select first_name, last_name
from employees
where emp_no >= (select avg(emp_no) 
				from employees);

select avg(emp_no) from employees


-- 평균 사범보다 높은 직원의 이름만 출력

select *
from employees e
where hire_date > (select avg(hire_date)
					from employees
					where emp_no = e.emp_no);

select emp_no, salary
from salaries
where salary in (select salary
				from salaries s
				order by salary desc);

select salary
from salaries s
order by salary desc;


-- 다중열 다중행 서브쿼리 
SELECT *
FROM salaries s 
WHERE (emp_no, salary) IN (SELECT emp_no, max(salary)
                           FROM salaries
                           GROUP BY emp_no);

-- 현재 직급정보
SELECT emp_no, title, to_date
FROM titles 
WHERE (emp_no, to_date) IN (SELECT emp_no, MAX(to_date)
                            FROM titles
                            GROUP BY emp_no);

SELECT * FROM salaries;

-- 가장 최근까지 연봉을 받은 사람
SELECT emp_no, salary, to_date
FROM salaries
WHERE (emp_no, to_date) IN (SELECT emp_no, max(to_date)
                            FROM salaries
                            GROUP BY emp_no);

-- Q1. 첫 입사 부서를 조회하세요.
SELECT emp_no, dept_no, from_date
FROM dept_emp
WHERE (emp_no, from_date) IN (SELECT emp_no, min(from_date)
                              FROM dept_emp                        
                              GROUP BY emp_no);

-- <인라인 뷰>
-- 인라인 뷰는 서브쿼리에서 FROM 절 안에 작성되는 서브쿼리
-- 마치 임시 테이블처럼 동작하며, 쿼리가 실행되는 동안에만 존재
SELECT *
FROM (SELECT de.dept_no, avg(s.salary)
      FROM dept_emp de
      JOIN salaries s ON de.emp_no = s.emp_no
      GROUP BY de.dept_no) a; 


SELECT *
FROM (SELECT emp_no, salary, salary*1.1 AS increment_salary
      FROM salaries
      ORDER BY increment_salary DESC 
      LIMIT 3) a -- (테이블명)
WHERE increment_salary >= 170000;

-- dept_no, 평균 연봉(salary)을 조회 (인라인뷰)
-- 메인쿼리에서 평균 연봉이 70000 이상인 부서만 조회
SELECT *
FROM (SELECT dept_no, avg(salary) AS avg_salary -- (별칭)
      FROM dept_emp de
      JOIN salaries s ON de.emp_no = s.emp_no 
      GROUP BY dept_no) t
WHERE avg_salary >= 70000;

-- Q2.
SELECT *
FROM (SELECT emp_no, avg(salary) AS avg_salary 
      FROM salaries
      GROUP BY emp_no) t -- (테이블 이름 무조건 지정)
WHERE avg_salary >= 80000;







